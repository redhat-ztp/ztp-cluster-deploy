- name: Clone ACM manifests there
  git:
    repo: "{{ hostvars[item].acm_manifest_repo }}"
    dest: "{{ acm_directory.path }}"

- name: Initialize sub path for rhacm manifests
  set_fact:
    manifests_sub_path: ""

- name: Set sub path for rhacm manifests
  set_fact:
    manifests_sub_path: "/{{ hostvars[item].acm_manifest_path }}" 
  when: > 
    hostvars[item].acm_manifest_path is defined and
    hostvars[item].acm_manifest_path != ''

- name: Prepare cluster Profile
  shell: "for kf in $(find {{ acm_directory.path }}{{ manifests_sub_path }}/subscriptions/ -name kustomization.yaml); do oc --kubeconfig={{ kubeconfig_hub_path }} apply -k $(echo $kf | rev | cut -d'/' -f 2- | rev); done"

- name: Import cluster to ACM
  shell: "{{ temporary_path }}/import_cluster.sh {{ hostvars[item].name }} {{ hostvars[item].profile }} {{ kubeconfig_hub_path }} {{ temporary_path }} {{ hostvars[item].hw }}"

- name: Give some time for object creation
  pause:
    minutes: 1

- name: Extract the klusterlet definition from ACM
  shell: "oc get secret/{{ hostvars[item].name }}-cluster-import -n {{ hostvars[item].name }}-cluster -o jsonpath={.data.crds\\\\.yaml} | base64 --decode > {{ acm_directory.path }}/crd.yaml"
  retries: 20
  delay: 30
  environment:
    KUBECONFIG: "{{ kubeconfig_hub_path }}"

- name: Extract the import command from ACM
  shell: "oc get secret/{{ hostvars[item].name }}-cluster-import -n {{ hostvars[item].name }}-cluster -o jsonpath={.data.import\\\\.yaml} | base64 --decode > {{ acm_directory.path }}/import.yaml"
  retries: 20
  delay: 30
  environment:
    KUBECONFIG: "{{ kubeconfig_hub_path }}"

- name: Apply the klusterlet definition on the spoke
  command: "oc apply -f {{ acm_directory.path }}/crd.yaml"
  environment:
    KUBECONFIG: "{{ hostvars[item].kubeconfig }}"

- name: Apply the import definition on the spoke
  command: "oc apply -f {{ acm_directory.path }}/import.yaml"
  environment:
    KUBECONFIG: "{{ hostvars[item].kubeconfig }}"
